# .github/workflows/ai-code-review.yml

name: AI Code Review with Gemini

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æœ‰ pull request é–‹å•Ÿæˆ–æ›´æ–°æ™‚è§¸ç™¼
on:
  pull_request:
    types: [opened, synchronize]

# è¨­å®šæ¬Šé™ï¼Œå…è¨± workflow å° pull requests å¯«å…¥ç•™è¨€
permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      # æ­¥é©Ÿ 1: å–å¾—å„²å­˜åº«çš„ç¨‹å¼ç¢¼
      # fetch-depth: 0 æœƒå–å¾—æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä»¥ä¾¿æˆ‘å€‘èƒ½æ¯”è¼ƒåˆ†æ”¯é–“çš„å·®ç•°
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥é©Ÿ 2: æŠ“å– Pull Request çš„ç¨‹å¼ç¢¼å·®ç•° (diff)
      # æˆ‘å€‘æ¯”è¼ƒ PR çš„ä¾†æºåˆ†æ”¯ (HEAD) èˆ‡ç›®æ¨™åˆ†æ”¯ (BASE)
      - name: Get PR Diff
        id: get_diff
        run: |
          # å¾ GitHub äº‹ä»¶çš„ payload ä¸­å–å¾— base å’Œ head çš„ commit SHA
          BASE_SHA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" ${{ github.event.pull_request.url }} | jq -r '.base.sha')
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          # ä½¿ç”¨ git diff ç”¢ç”Ÿå·®ç•°ï¼Œä¸¦å°‡çµæœå„²å­˜åˆ°ä¸€å€‹æš«å­˜æª”ä¸­
          git diff --no-color "${BASE_SHA}" "${HEAD_SHA}" > diff.txt
          
          # æª¢æŸ¥ diff.txt æ˜¯å¦ç‚ºç©ºï¼Œå¦‚æœç‚ºç©ºå‰‡çµ‚æ­¢å¾ŒçºŒæ­¥é©Ÿ
          if [ ! -s diff.txt ]; then
            echo "No code changes detected. Skipping AI review."
            echo "continue=false" >> $GITHUB_OUTPUT
          else
            echo "Code changes detected. Proceeding with AI review."
            echo "continue=true" >> $GITHUB_OUTPUT
          fi


      # æ­¥é©Ÿ 3: å‘¼å« Gemini API é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥ (åƒ…ç•¶æœ‰ç¨‹å¼ç¢¼å·®ç•°æ™‚åŸ·è¡Œ)
      - name: Call Gemini API for Code Review
        id: call_gemini
        if: steps.get_diff.outputs.continue == 'true'
        run: |
          # è®€å– diff æª”æ¡ˆå…§å®¹
          CODE_DIFF=$(cat diff.txt)

          # ä½¿ç”¨ jq å·¥å…·å®‰å…¨åœ°å»ºç«‹ JSON payloadï¼Œé¿å…ç‰¹æ®Šå­—å…ƒå•é¡Œ
          # é€™è£¡æˆ‘å€‘å°‡æ‚¨çš„è¨­å®šå’Œå•é¡Œæ•´åˆé€²å»
          JSON_PAYLOAD=$(jq -n --arg diff "$CODE_DIFF" '{
            "contents": [{
              "parts": [{
                "text": "ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç¨‹å¼ç¢¼å¯©æŸ¥å“¡ (Senior Code reviewer)ï¼Œå°ˆé•·åœ¨æ–¼æ‰¾å‡ºæŠ€è¡“å‚µã€é‡æ§‹å»ºè­°èˆ‡ clean code å’Œ SOLID åŸå‰‡ã€‚\n\nä»¥ä¸‹æ˜¯ pull request çš„ç¨‹å¼ç¢¼å·®ç•° (diff)ï¼Œè«‹æ ¹æ“šä½ çš„å°ˆæ¥­ï¼Œå¯©æŸ¥é€™æ®µç¨‹å¼ç¢¼ã€‚è«‹æ˜ç¢ºæŒ‡å‡ºæ˜¯å¦æœ‰æ½›åœ¨çš„æŠ€è¡“å‚µã€ç¨‹å¼ç¢¼å£å‘³é“ (code smell)ã€æœªä¾†çš„ç¶­è­·é¢¨éšªæˆ–æ½›åœ¨çš„å®‰å…¨æ€§å•é¡Œã€‚æœ€å¾Œï¼Œè«‹ä»¥æ¢åˆ—å¼çš„æ–¹å¼æä¾›å…·é«”çš„é‡æ§‹å»ºè­°ã€‚\n\n---ç¨‹å¼ç¢¼å·®ç•°é–‹å§‹---\n\n" + $diff + "\n\n---ç¨‹å¼ç¢¼å·®ç•°çµæŸ---"
              }]
            }],
            "generationConfig": {
              "temperature": 0.4,
              "topK": 32,
              "topP": 1,
              "maxOutputTokens": 4096,
              "stopSequences": []
            },
            "safetySettings": [
              { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
              { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
              { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
              { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }
            ]
          }')

          # å‘¼å« Gemini API
          API_KEY="${{ secrets.GEMINI_API_KEY }}"
          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}" \
               -H "Content-Type: application/json" \
               -d "${JSON_PAYLOAD}"
          )
          
          # å¾å›æ‡‰ä¸­è§£æå‡ºå¯©æŸ¥å»ºè­°
          REVIEW_COMMENT=$(echo "${RESPONSE}" | jq -r '.candidates[0].content.parts[0].text')
          
          # å°‡å¯©æŸ¥å»ºè­°å­˜ç‚ºå¾ŒçºŒæ­¥é©Ÿå¯ä»¥ä½¿ç”¨çš„æ ¼å¼
          # æˆ‘å€‘ä½¿ç”¨ä¸€å€‹ç‰¹æ®Šçš„ EOF æ¨™è¨˜ä¾†è™•ç†å¤šè¡Œæ–‡å­—
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "${REVIEW_COMMENT}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥é©Ÿ 4: å°‡ Gemini çš„å¯©æŸ¥å»ºè­°ç•™è¨€åˆ° Pull Request ä¸Š
      - name: Post Review Comment to PR
        if: steps.get_diff.outputs.continue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewComment = `${{ steps.call_gemini.outputs.review_comment }}`;
            const issue_number = context.issue.number;
            const repo = context.repo;

            const comment = `
            ### ğŸ¤– Gemini AI Code Review

            Hello there! I've reviewed the changes in this pull request. Here are my findings and suggestions:

            ---

            ${reviewComment}

            ---

            *Please note: This is an automated review by Gemini. Human oversight is still recommended.*
            `;

            await github.rest.issues.createComment({
              ...repo,
              issue_number: issue_number,
              body: comment
            });
